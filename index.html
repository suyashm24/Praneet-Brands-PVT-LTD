<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Retail Inventory - Centered PDF Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { 
            --header-bg: #92d050; --primary: #10b981; --danger: #ef4444; 
            --border: #000000; --bg-body: #f8fafc; --bg-card: #ffffff;
            --text-main: #1e293b; --input-bg: #ffffff; --table-stripe: #f1f5f9;
        }
        body.dark-mode {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9;
            --border: #475569; --input-bg: #334155; --table-stripe: #1e293b;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 10px; transition: 0.3s; }
        .container { max-width: 100%; margin: 10px auto; background: var(--bg-card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: 15px; text-align: center; width: 320px; border: 2px solid var(--header-bg); }
        .login-card input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); }

        .brand-header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid var(--header-bg); padding-bottom: 15px; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-weight: bold; color: var(--text-main); border-radius: 5px; }
        .tab-btn.active { background: var(--header-bg); color: #000; }

        .month-group-header { background: #334155; color: white; padding: 10px; font-weight: bold; margin-top: 20px; border-radius: 5px 5px 0 0; text-transform: uppercase; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; border: 1px solid var(--border); margin-bottom: 10px; }
        th { background: var(--header-bg); color: #000; padding: 10px; border: 1px solid var(--border); text-align: center; font-weight: bold; }
        td { padding: 8px; border: 1px solid var(--border); color: var(--text-main); text-align: center; }
        tr:nth-child(even) { background: var(--table-stripe); }
        
        .view-section { display: none; }
        .view-section.active-view { display: block; }
        .hidden-app { display: none !important; }

        #editModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: var(--bg-card); padding: 25px; border-radius: 12px; width: 90%; max-width: 700px; border: 1px solid var(--header-bg); }
        .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .edit-grid div { display: flex; flex-direction: column; }
        .edit-grid label { font-size: 0.7rem; font-weight: bold; margin-bottom: 3px; }

        .action-btns button { padding: 2px 5px; cursor: pointer; background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border); border-radius: 3px; font-size: 0.7rem; margin: 0 1px; }
        .btn-action { background: #1e293b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.75rem; }
        body.dark-mode .btn-action { background: var(--header-bg); color: black; }
        
        .filter-bar { background: var(--table-stripe); padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .filter-bar input { padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); }
        #multiDeleteBar { display: none; background: rgba(239, 68, 68, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; justify-content: space-between; align-items: center; border: 1px solid var(--danger); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2>üîí Admin Login</h2>
        <input type="password" id="passInput" placeholder="Login Password (123)" onkeypress="if(event.key==='Enter') login()">
        <button onclick="login()" style="width:100%; padding:12px; background:var(--header-bg); border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Unlock</button>
        <p id="loginError" style="color:var(--danger); display:none; margin-top:10px;">Incorrect Password</p>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3 style="margin-top:0;">üìù Edit Product Details</h3>
        <div id="editFields" class="edit-grid"></div>
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="closeEdit()" style="padding:10px 20px; border:1px solid var(--border); background:none; color:var(--text-main); border-radius:5px; cursor:pointer;">Cancel</button>
            <button onclick="saveEdit()" style="padding:10px 25px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Update Inventory</button>
        </div>
    </div>
</div>

<div id="appContainer" class="hidden-app">
    <div class="container">
        <div class="brand-header">
            <button onclick="logout()" style="float: right; background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Logout</button>
            <button onclick="toggleDarkMode()" id="themeBtn" style="float: right; margin-right:10px; padding:8px 15px; border-radius:5px; cursor:pointer;">üåô Dark Mode</button>
            <img src="your-logo-file.jpeg" alt="Logo" style="max-height:50px;" onerror="this.src='https://via.placeholder.com/200x50?text=BRAND+LOGO'">
        </div>

        <div class="nav-bar">
            <div class="tabs">
                <button class="tab-btn active" id="tab-inv" onclick="switchView('inv')">üìã Inventory List</button>
                <button class="tab-btn" id="tab-hist" onclick="switchView('hist')">üìú History Logs</button>
            </div>
            <div style="display:flex; gap:5px;">
                <button id="undoBtn" onclick="undo()" style="padding:8px; border-radius:5px; border:1px solid var(--border); cursor:pointer;" disabled>‚Ü©Ô∏è Undo</button>
                <button id="redoBtn" onclick="redo()" style="padding:8px; border-radius:5px; border:1px solid var(--border); cursor:pointer;" disabled>‚Ü™Ô∏è Redo</button>
            </div>
        </div>

        <div id="view-inv" class="view-section active-view">
            <div id="multiDeleteBar">
                <span>Selected: <strong id="selCount">0</strong> items</span>
                <button onclick="deleteSelected()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">üóëÔ∏è Delete Selected</button>
            </div>
            <div style="background:rgba(146, 208, 80, 0.1); border:2px dashed var(--header-bg); padding:10px; text-align:center; margin-bottom:15px; border-radius: 8px;">
                <strong>Paste Excel Rows:</strong> <input type="text" id="excelInput" placeholder="Paste data here..." style="padding:8px; width:200px; border:1px solid var(--border);">
            </div>
            <input type="text" id="search" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid var(--border); border-radius:5px; background:var(--input-bg); color:var(--text-main);" placeholder="Search inventory..." onkeyup="render()">
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="masterCheck" onclick="selectAll(this)"></th>
                            <th>SR.NO.</th><th>BRAND Name</th><th>EAN/GS1</th><th>ARTICLE DESCRIPTION</th><th>Collection</th><th>PRODUCT</th><th>SIZE</th><th>SIZE 1</th><th>MRP</th><th>Pack Size</th><th>BALANCE STOCK</th><th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-hist" class="view-section">
            <div class="filter-bar">
                <strong>Filter Date:</strong>
                From: <input type="date" id="histFrom" onchange="render()">
                To: <input type="date" id="histTo" onchange="render()">
                <button onclick="resetHistFilter()" class="btn-action">Reset</button>
                <div style="flex-grow:1; text-align:right;">
                    <button onclick="exportPDF()" class="btn-action">üì• Download PDF Report</button>
                    <button onclick="clearAllLogs()" class="btn-action" style="background:var(--danger); color:white;">üóëÔ∏è Wipe All Logs</button>
                </div>
            </div>
            <div id="historyContainer"></div>
        </div>
    </div>
</div>

<script>
    const LOGIN_PASSWORD = "123";
    const DELETE_PASSWORD = "456";

    let inventory = JSON.parse(localStorage.getItem('ret_inv_final_v13')) || [];
    let logs = JSON.parse(localStorage.getItem('ret_logs_final_v13')) || [];
    let undoStack = [], redoStack = [], selectedIds = new Set(), currentEditId = null;

    if (localStorage.getItem('dark') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeBtn').innerText = "‚òÄÔ∏è Light Mode";
    }

    function login() {
        if(document.getElementById('passInput').value === LOGIN_PASSWORD) {
            sessionStorage.setItem('auth', 'true');
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContainer').classList.remove('hidden-app');
            render();
        } else { document.getElementById('loginError').style.display = 'block'; }
    }
    if(sessionStorage.getItem('auth') === 'true') {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContainer').classList.remove('hidden-app');
    }

    function toggleDarkMode() {
        let isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('dark', isDark);
        document.getElementById('themeBtn').innerText = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
    }

    function captureSnapshot() {
        undoStack.push(JSON.stringify({inv: inventory, log: logs}));
        if(undoStack.length > 50) undoStack.shift();
        redoStack = [];
        updateUI();
    }

    function undo() {
        if(!undoStack.length) return;
        redoStack.push(JSON.stringify({inv: inventory, log: logs}));
        const snapshot = JSON.parse(undoStack.pop());
        inventory = snapshot.inv; logs = snapshot.log;
        save(true);
    }

    function redo() {
        if(!redoStack.length) return;
        undoStack.push(JSON.stringify({inv: inventory, log: logs}));
        const snapshot = JSON.parse(redoStack.pop());
        inventory = snapshot.inv; logs = snapshot.log;
        save(true);
    }

    function updateUI() {
        document.getElementById('undoBtn').disabled = !undoStack.length;
        document.getElementById('redoBtn').disabled = !redoStack.length;
    }

    function save(isUndoRedo = false) {
        localStorage.setItem('ret_inv_final_v13', JSON.stringify(inventory));
        localStorage.setItem('ret_logs_final_v13', JSON.stringify(logs));
        if(!isUndoRedo) captureSnapshot();
        updateUI();
        render();
    }

    function formatDate(isoString) {
        const date = new Date(isoString);
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function render() {
        const iBody = document.getElementById('inventoryBody');
        const hContainer = document.getElementById('historyContainer');
        const q = document.getElementById('search').value.toLowerCase();
        const fromDate = document.getElementById('histFrom').value;
        const toDate = document.getElementById('histTo').value;

        iBody.innerHTML = '';
        inventory.forEach((p, i) => {
            if ((p.brand+p.ean+p.desc).toLowerCase().includes(q)) {
                const isChecked = selectedIds.has(p.id.toString());
                iBody.innerHTML += `<tr>
                    <td><input type="checkbox" class="row-check" data-id="${p.id}" ${isChecked ? 'checked' : ''} onclick="toggleSelect(${p.id})"></td>
                    <td>${i+1}</td><td>${p.brand}</td><td>${p.ean}</td><td>${p.desc}</td>
                    <td>${p.collection}</td><td>${p.product}</td><td>${p.size}</td><td>${p.size1}</td>
                    <td>‚Çπ${p.mrp}</td><td>${p.pack}</td><td style="font-weight:bold;">${p.stock}</td>
                    <td><div class="action-btns">
                        <button onclick="moveItem(${i}, -1)">üîº</button>
                        <button onclick="moveItem(${i}, 1)">üîΩ</button>
                        <button onclick="openEdit(${p.id})">üìù</button>
                        <button onclick="adjust(${p.id}, 'IN')" style="color:var(--primary)">+</button>
                        <button onclick="adjust(${p.id}, 'OUT')" style="color:var(--danger)">-</button>
                        <button onclick="deleteOne(${p.id})">üóëÔ∏è</button>
                    </div></td></tr>`;
            }
        });

        hContainer.innerHTML = '';
        const monthsLong = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
        const groups = {};
        logs.forEach(l => {
            const date = new Date(l.time);
            const dateStr = l.time.split('T')[0];
            if (fromDate && dateStr < fromDate) return;
            if (toDate && dateStr > toDate) return;
            const key = `${monthsLong[date.getMonth()]} ${date.getFullYear()}`;
            if (!groups[key]) groups[key] = [];
            groups[key].push(l);
        });

        for (const [mYear, items] of Object.entries(groups)) {
            let section = `<div class="month-group-header">${mYear}</div><table>
                <thead><tr><th>Date & Time</th><th>EAN</th><th>Description</th><th>Action</th><th>Qty</th><th>Bal</th><th>Del</th></tr></thead><tbody>`;
            items.forEach(l => {
                const globalIdx = logs.indexOf(l);
                const timeStr = new Date(l.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                section += `<tr>
                    <td>${formatDate(l.time)} | ${timeStr}</td><td>${l.ean}</td><td>${l.desc}</td>
                    <td style="color:${l.type==='IN'?'var(--primary)':'var(--danger)'}; font-weight:bold">${l.type}</td>
                    <td>${l.qty}</td><td>${l.bal}</td>
                    <td><button onclick="deleteLog(${globalIdx})" style="border:none; background:none; cursor:pointer;">‚ùå</button></td></tr>`;
            });
            section += `</tbody></table>`;
            hContainer.innerHTML += section;
        }
        document.getElementById('multiDeleteBar').style.display = selectedIds.size ? 'flex' : 'none';
        document.getElementById('selCount').innerText = selectedIds.size;
    }

    function resetHistFilter() { document.getElementById('histFrom').value = ''; document.getElementById('histTo').value = ''; render(); }
    function selectAll(m) { selectedIds.clear(); if(m.checked) inventory.forEach(p => selectedIds.add(p.id.toString())); render(); }
    function toggleSelect(id) { const s = id.toString(); if(selectedIds.has(s)) selectedIds.delete(s); else selectedIds.add(s); render(); }

    function deleteSelected() {
        if(prompt(`Enter DELETE Password to delete ${selectedIds.size} items:`) === DELETE_PASSWORD) {
            captureSnapshot(); inventory = inventory.filter(p => !selectedIds.has(p.id.toString())); selectedIds.clear(); document.getElementById('masterCheck').checked = false; save(true);
        } else { alert("Incorrect Password!"); }
    }

    function openEdit(id) {
        if(prompt("Enter MASTER Password to Edit:") === DELETE_PASSWORD) {
            currentEditId = id; const p = inventory.find(x => x.id === id);
            const fields = [['brand','BRAND Name'], ['ean','EAN/GS1'], ['desc','ARTICLE DESCRIPTION'], ['collection','Collection'], ['product','PRODUCT'], ['size','SIZE'], ['size1','SIZE 1'], ['mrp','MRP'], ['pack','Pack Size'], ['stock','BALANCE STOCK']];
            document.getElementById('editFields').innerHTML = fields.map(f => `<div><label>${f[1]}</label><input id="edit-${f[0]}" value="${p[f[0]] || ''}" ${f[0] === 'stock' ? 'type="number"' : ''}></div>`).join('');
            document.getElementById('editModal').style.display = 'flex';
        }
    }

    function saveEdit() {
        captureSnapshot(); const p = inventory.find(x => x.id === currentEditId);
        ['brand','ean','desc','collection','product','size','size1','mrp','pack','stock'].forEach(k => {
            const val = document.getElementById(`edit-${k}`).value;
            p[k] = (k === 'mrp' || k === 'stock') ? parseFloat(val) || 0 : val;
        });
        closeEdit(); save(true);
    }

    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
    function moveItem(idx, dir) { if(idx + dir < 0 || idx + dir >= inventory.length) return; captureSnapshot(); [inventory[idx], inventory[idx+dir]] = [inventory[idx+dir], inventory[idx]]; save(true); }
    function deleteOne(id) { if(prompt("Enter DELETE Password:") === DELETE_PASSWORD) { captureSnapshot(); inventory = inventory.filter(p => p.id !== id); save(true); } }
    function deleteLog(idx) { if(prompt("Enter DELETE Password:") === DELETE_PASSWORD) { captureSnapshot(); logs.splice(idx, 1); save(true); } }
    function clearAllLogs() { if(prompt("Enter DELETE Password to wipe history:") === DELETE_PASSWORD) { captureSnapshot(); logs = []; save(true); } }

    function adjust(id, type) {
        const amt = parseInt(prompt(`Quantity to ${type}:`, "1"));
        if(amt > 0) {
            captureSnapshot(); const p = inventory.find(x => x.id === id);
            if(type==='OUT' && p.stock < amt) return alert("Insufficient Stock!");
            p.stock = type === 'IN' ? p.stock + amt : p.stock - amt;
            logs.unshift({ time: new Date().toISOString(), ean: p.ean, desc: p.desc, type, qty: amt, bal: p.stock });
            save(true);
        }
    }

    document.getElementById('excelInput').addEventListener('paste', function(e) {
        e.preventDefault(); captureSnapshot();
        const data = (e.clipboardData || window.clipboardData).getData('text');
        data.trim().split('\n').forEach(row => {
            const c = row.split('\t');
            if (c.length >= 4) {
                const item = { id: Date.now() + Math.random(), brand: c[1]||'', ean: c[2]||'', desc: c[3]||'', collection: c[4]||'', product: c[5]||'', size: c[6]||'', size1: c[7]||'', mrp: parseFloat(c[8])||0, pack: c[9]||'', stock: parseInt(c[10])||0 };
                inventory.push(item);
                if(item.stock > 0) logs.unshift({ time: new Date().toISOString(), ean: item.ean, desc: item.desc, type: 'IN', qty: item.stock, bal: item.stock });
            }
        });
        save(true); this.value = '';
    });

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l'); // Landscape orientation for better spacing
        const pageWidth = doc.internal.pageSize.getWidth();
        
        doc.setFontSize(16);
        doc.text("Inventory Valuation Report", pageWidth / 2, 15, { align: 'center' });
        
        doc.autoTable({
            startY: 20,
            head: [['SR.NO.', 'EAN/GS1', 'ARTICLE DESCRIPTION', 'Collection', 'BALANCE STOCK']],
            body: inventory.map((p, i) => [i+1, p.ean, p.desc, p.collection, p.stock]),
            theme: 'grid',
            headStyles: { fillColor: [146, 208, 80], halign: 'center' },
            bodyStyles: { halign: 'center' },
            columnStyles: {
                0: { cellWidth: 20 },
                1: { cellWidth: 40 },
                2: { cellWidth: 'auto' },
                3: { cellWidth: 40 },
                4: { cellWidth: 35 }
            },
            margin: { left: 10, right: 10 }
        });
        doc.save(`Inventory_Report_${new Date().toLocaleDateString()}.pdf`);
    }

    function switchView(v) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-' + v).classList.add('active-view');
        document.getElementById('tab-' + v).classList.add('active');
        render();
    }

    function logout() { sessionStorage.removeItem('auth'); location.reload(); }
    render();
</script>
</body>
</html>